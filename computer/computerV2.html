<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	  "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>4-bit computer</title>
    <script src="../numbers/converters.js"></script>
    <script src="computer.js"></script>
    <!-- jQuery -->
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.3.min.js"></script>

    <!-- Tipped  See http://www.tippedjs.com/  and http://www.tippedjs.com/license -->
    <script type="text/javascript" src="./tipped.js"></script>
    <link rel="stylesheet" type="text/css" href="./tipped.css" />
    <style>
    body {
       font-family:"Times";
    }
    </style>

    <script type='text/javascript'>
    $(document).ready(function() {
      Tipped.create('.boxes .box');
    });
    </script>
    <script type="text/javascript">
     $(document).ready(function() {
      Tipped.create('.data', function(element) {
        var addr = $(element).data('id');
        return "Data: " + ram[addr] ;
      }, {
       cache: false
      });
     });

     $(document).ready(function() {
      Tipped.create('.instr', function(element) {
        var addr = $(element).data('id');
        return "Instruction: " + parseInstr(ram[addr]) ;
      }, {
       cache: false
      });
     });

     $(document).ready(function() {
      Tipped.create('#pctr', function() {
        return "Program Counter: " + pcounter ;
      }, {
       cache: false
      });
     });

     $(document).ready(function() {
      Tipped.create('#preg', function() {
        return "Program Register: " + parseInstr(pregister);
      }, {
       cache: false
      });
     });

     $(document).ready(function() {
      Tipped.create('#rega', function() {
        return "RegisterA: " + registerA ;
      }, {
       cache: false
      });
     });
    </script>
    <script Language="JavaScript">
      
      // The computer's internal registers and RAM
      var pcounter = 0;
      var pregister = 0;
      var registerA = 0;
      var registerB = 0;

      var ram = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
      var dataIndex = 0;   // Data segment 0..7
      var progIndex = 8;   // Prog segment 8..15

      var op = ["NOP", "GET", "PUT", "ADD", "SUB", "MUL", "DIV", "UND","PRN", "INP", "UND","UND","UND","UND","UND","UND"];
      var symboltable = [];
      var symbolctr = 0;
      var instrctr = 0;
      var DATA_SEG = 8;
      var INSTR_SEG = 0;
   
      //  Reset the computer -- like restarting
      function reset() {
        alert("Restarting...");
        pcounter = 0;
        pregister = 0;
        registerA = 0;
        registerB = 0;
        for (var i=0; i < 16; i++) {
	  ram[i] = 0;
        }
	resetVisual();
      }

     // Display the current state of the computer after reset
     function resetVisual() {
       document.getElementById('exec').disabled=true;
       document.getElementById('fetch').disabled=false;

       document.getElementById("pctr").value = pad(decToBinary(pcounter), 4);
       document.getElementById("preg").value = pad(decToBinary(pregister), 8);
       document.getElementById("rega").value = pad(decToBinary(registerA), 8);
       for (var i=0; i < 16; i++) {
         var id = "m" + pad(decToBinary(i), 4);
         document.getElementById(id).value = pad(decToBinary(ram[i]), 8);
       }
     }

     function parseInstr(n) {
        var str = pad(decToBinary(n), 8);
        var instr = binaryToDecimal(str.substring(0,4));
        var addr = str.substring(4);
        return op[instr] + " " + addr;
     }

     function handleKeyboardInput() {
       if (event.keyCode == 13) {
        // alert(document.getElementById('keyboard').value);        
       }
     }

     // Restricts input in memory textfields to 0s and 1s
     // NOTE: Chrome, Firefox, and Safari may handle keyCode differently
     function handleRAM(textfield, event) {
       console.log("keycode=" + event.keyCode);
       textfield.value = textfield.value.replace(/[^0-1]/,'');
       var id = textfield.id;
       var addr = binaryToDecimal(id.substring(1));
       ram[addr] = binaryToDecimal(textfield.value);
       
//       if (event.keyCode == 13) {
//         ram[addr] = binaryToDecimal(textfield.value);
//       }
     }

     // Copy all input elements to memory
     function updateState() {
       for (var i=0; i < 16; i++) {
         var id = "m" + pad(decToBinary(i), 4);
         ram[i] = binaryToDecimal(document.getElementById(id).value);
       }
     }

     function loadProgram() {
        var code = document.getElementById("editor").value;
        symboltable = [];
        symbolctr = 0;
        instrctr = 0;
        code = code.trim();        
        if (!code.endsWith('\n')) {  // Add a CR if necessary
           code += '\n';
        }
        var ctr = 1;
        var cr = code.indexOf('\n');
        var line = code.substring(0, cr).trim();
        while (line != "") {
          var op = line.substring(0,3);
          if (op == "VAR") {
            if (!parseVarDeclaration(line, ctr)) 
              return;  // ERROR
          } else if (op == "NOP") {
            return;
          } else if ("GETPUTADDSUBMULDIVPRNINP".indexOf(op) != -1) {
            if (!parseInstruction(line, op, ctr)) 
              return;  // ERROR
          } else {
            alert("Illegal symbol in line " + ctr);
            return;
          }
          code = code.substring(cr+1);
          cr = code.indexOf('\n');
          line = code.substring(0,cr).trim();
          ctr += 1;
       }
     }

     function parseInstruction(line, op, ctr) {
       var opcode = getOpCode(op);
       if (opcode == -1) {
         alert("Illegal operation:" + op);
         return false;
       }
       var operand = line.substring(3).trim();
       var addr = getOperandAddr(operand);
       if (addr == -1) {
         alert("Illegal operand: " + operand);
         return false;
       }
       var bOpcode = pad(decToBinary(opcode),4);
       var bAddr = pad(decToBinary(addr), 4);
       var decInstr = binaryToDecimal(bOpcode+bAddr);
       ram[INSTR_SEG + instrctr] = decInstr;
       var id = "m" + pad(decToBinary(INSTR_SEG + instrctr), 4);
       document.getElementById(id).value = pad(decToBinary(decInstr), 8);
       instrctr += 1;
       return true;
     }

     function getOperandAddr(operand) {
       for (var i = 0; i < symboltable.length; i++) {
          if (symboltable[i][0] == operand) {
            return symboltable[i][1];
          }
       }
       return -1;
     }     

     function getOpCode(opstr) {
       for (var i = 0; i < op.length; i++) {
          if (op[i] == opstr)
            return i;
       }
       return -1;
     }

     function parseVarDeclaration(line, ctr) {
       var assignment = line.substring(3).trim();
       var op = assignment.indexOf('=');
       if (op == -1) {
         alert("Syntax error in line " + ctr);
         return false;
       }
       var symbol = assignment.substring(0, op).trim();
       var value = assignment.substring(op + 1).trim();
       value = parseInt(value);
       if (value == NaN) {
         alert("Syntax error in line " + ctr);
         return false;
       }          
       symboltable.push([symbol, DATA_SEG + symbolctr]);
       // Put it in memory
       ram[DATA_SEG + symbolctr] = value;
       var id = "m" + pad(decToBinary(DATA_SEG + symbolctr), 4);
       document.getElementById(id).value = pad(decToBinary(value), 8);
       symbolctr += 1;
       return true;
     }

     function fetchExecute() {
       updateState();
       pcounter = 0;
       document.getElementById("pctr").value = pad(decToBinary(pcounter),8);
       fetchNextInstruction();
       executeCurrentInstruction();
       var instrcode = pad(decToBinary(pregister),8).substring(0,4);
       while (binaryToDecimal(instrcode) != 0) {
         fetchNextInstruction();
         executeCurrentInstruction();
         instrcode = pad(decToBinary(pregister),8).substring(0,4);
       }
     }

     function step() {
       fetchNextInstruction();
       executeCurrentInstruction();
     }

     function fetchNextInstruction() {
        updateState();
        var pctr = binaryToDecimal(document.getElementById("pctr").value);
        var instr = ram[pctr];
        document.getElementById("preg").value = pad(decToBinary(instr), 8);
        pregister = instr;
        pctr += 1;
        if (pctr > 7) 
          pctr = 0;
        pcounter = pctr;
        document.getElementById("pctr").value = pad(decToBinary(pctr), 4);
        document.getElementById("fetch").disabled=true;
        document.getElementById("exec").disabled=false;
     }

     function executeCurrentInstruction() {
        document.getElementById("fetch").disabled=false;
        document.getElementById("exec").disabled=true;
        var preg =  document.getElementById("preg").value;
        var instr = binaryToDecimal(preg.substring(0,4));
        var addrbin = preg.substring(4)
        var addr = binaryToDecimal(addrbin);
        var operand = ram[addr];
      
       if (instr == 1)  {   // GET x and put in registerA
          registerA = ram[addr];
          document.getElementById("rega").value = pad(decToBinary(ram[addr]),8);
       }
       if (instr == 2)  {   // Put regA at x
          var rega = binaryToDecimal(document.getElementById("rega").value);
          ram[addr] = rega;
          document.getElementById("m"+addrbin).value = pad(decToBinary(ram[addr]),8);
       }
       if (instr == 3)  {   // Add x to register
          registerA = (registerA + operand)  % 256;
          document.getElementById("rega").value = pad(decToBinary(registerA),8);
       }
       if (instr == 4)  {   // Sub x from register
          registerA = (registerA - operand) % 256;
          document.getElementById("rega").value = pad(decToBinary(registerA),8);
       }
       if (instr == 5)  {   // Mult  register by x
          registerA = (registerA * operand) % 256;
          document.getElementById("rega").value = pad(decToBinary(registerA),8);
       }
       if (instr == 6)  {   // Div  register by x
          registerA = (Math.floor(registerA / operand)) % 256;
          document.getElementById("rega").value = pad(decToBinary(registerA),8);
       }
       if (instr == 8)  {   // Print x
          var monitor = document.getElementById("monitor");
          monitor.value = monitor.value + ram[addr] + "\n" ;
       }
       if (instr == 9)  {   // Read keyboard into x and echo it
          var input = prompt("Input a number at the keyboard: ");
          input = input % 256;
          var keyboard = document.getElementById("keyboard").value = input;
          var monitor = document.getElementById("monitor");
          monitor.value = monitor.value + ">" + keyboard + "\n";
          ram[addr] = keyboard;
          document.getElementById("m"+addrbin).value = pad(decToBinary(ram[addr]),8);
       }
     }
 
     function init() {
        document.getElementById("monitor").cols = "30";
        document.getElementById("editor").cols = "30";
        document.getElementById("keyboard").size = "75";
     }

   </script>
  </head>
  <body onload='init()'>
    <table width="550" align="center" border="1" frame="box" rules="none">  <!-- Main Container -->
      <tr>
	<td>
	  <img src="./android_CSP-128px.jpg">
	</td>
	<td>
	  <h1>4-Bit Computer Simulator</h1>
	</td>
      </tr>
      <tr>
	<td colspan="2">
	  <TABLE ALIGN="CENTER" BGCOLOR="#AAAAAA" BORDER="1" CELLPADDING="5">  <!-- Computer table -->
	    <TR>
	      <TD>
		<CENTER>
		  <div id="userinterface">
                    <table border="0">
                      <tr>
                        <td>
                          <table><tr><td>
   			      <font color="red">Monitor</font><br />
			      <textarea id="monitor" rows="10" col="30" readonly></textarea>
                            </td><td>
			      <font color="red">Editor</font><br />
                              <textarea id="editor" rows="10" col="40"></textarea>
                            </td><td>
                              <button type="button" id="run" onclick="loadProgram()">Load</button>
                            </td>
                          </tr>
                          </table>       
                        </td>
                      </tr>
                      <tr>
                        <td>
                          <font color="red">Keyboard</font><br />
 			  <input id="keyboard" type="text" maxlenvth="40" size="40" onkeydown="handleKeyboardInput()" disabled></input>
                        </td>
                      </tr>
                    </table>
		  </div>
		</CENTER>
	      </TD>
	    </TR>

	    <tr>
	      <td>
               <div class='boxes position'>  <!-- start of boxes for tipped -->
		<table border="1">  <!-- RAM and CPU table -->
		  <tr>
		    <td>
		      <div id="ram" style="visibility:visible">
			<font color="red">RAM</font><br />
                        <table><tr><td><u>INST</u></td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
                            <td><u>DATA</u></td><td>&nbsp;</td></tr></table>

                        <table><tr><td>0000:</td><td><span class='instr' data-id="0"><input onkeyup="handleRAM(this,event)" id="m0000" type="text" size="8" value="00000000" maxlength="8"></span></td>
                            <td>1000:</td><td><span class='data' data-id="8"><input id="m1000"  onkeyup="handleRAM(this,event)" type="text" size="8" value="00000000" maxlength="8"></span></td></tr>
                        </table>

                        <table><tr><td>0001:</td><td><span class='instr' data-id="1"><input id="m0001"  onkeyup="handleRAM(this,event)" type="text" size="8" value="00000000" maxlength="8"></span></td>
                            <td>1001:</td><td><span class='data' data-id="9"><input id="m1001"  onkeyup="handleRAM(this,event)" type="text" size="8" value="00000000" maxlength="8"></span></td></tr>
                        </table>
                        <table><tr><td>0010:</td><td><span class='instr' data-id="2"><input id="m0010"  onkeyup="handleRAM(this,event)" type="text" size="8" value="00000000" maxlength="8" ></span></td>
                            <td>1010:</td><td><span class='data' data-id="10"><input id="m1010"  onkeyup="handleRAM(this,event)" type="text" size="8" value="00000000" maxlength="8" ></span></td></tr>
                        </table>
                        <table><tr><td>0011:</td><td><span class='instr' data-id="3"><input id="m0011"  onkeyup="handleRAM(this,event)" type="text" size="8" value="00000000" maxlength="8" ></span></td>
                            <td>1011:</td><td><span class='data' data-id="11"><input id="m1011"  onkeyup="handleRAM(this,event)" type="text" size="8" value="00000000" maxlength="8" ></span></td></tr>
                        </table>
                        <table><tr><td>0100:</td><td><span class='instr' data-id="4"><input id="m0100"  onkeyup="handleRAM(this,event)" type="text" size="8" value="00000000" maxlength="8" ></span></td>
                            <td>1100:</td><td><span class='data' data-id="12"><input id="m1100"  onkeyup="handleRAM(this,event)" type="text" size="8" value="00000000" maxlength="8" ></span></td></tr>
                        </table>
                        <table><tr><td>0101:</td><td><span class='instr' data-id="5"><input id="m0101"  onkeyup="handleRAM(this,event)" type="text" size="8" value="00000000" maxlength="8" ></span></td>
                            <td>1101:</td><td><span class='data' data-id="13"><input id="m1101" onkeyup="handleRAM(this,event)"  type="text" size="8" value="00000000" maxlength="8" ></span></td></tr>
                        </table>
                        <table><tr><td>0110:</td><td><span class='instr' data-id="6"><input id="m0110"  onkeyup="handleRAM(this,event)" type="text" size="8" value="00000000" maxlength="8" ></span></td>
                            <td>1110:</td><td><span class='data' data-id="14"><input id="m1110"  onkeyup="handleRAM(this,event)" type="text" size="8" value="00000000" maxlength="8" ></span></td></tr>
                        </table>
                        <table><tr><td>0111:</td><td><span class='instr' data-id="7"><input id="m0111"  onkeyup="handleRAM(this,event)" type="text" size="8" value="00000000" maxlength="8" ></span></td>
                            <td>1111:</td><td><span class='data' data-id="15"><input id="m1111"  onkeyup="handleRAM(this,event)" type="text" size="8" value="00000000" maxlength="8" ></span></td></tr>
                        </table>
                        <br /><br />
		      </div>
		    </td>
		    <td>
                      <font color="red">CPU</font><br />
		      <div id="cpu" style="visibility:visible">
                        <table><tr><td><u>PCTR:</u>&nbsp;</td><td><input id="pctr" type="text" size="4" value="0000" maxlength="4" readonly></td>
                            <td><u>PREG:</u></td><td><input id="preg" type="text" size="8"  value="00000000" maxlength="8" readonly></td></tr></table>
                        <table><tr><td><u>REGA:</u></td><td><input id="rega" type="text" size="8"  value="00000000" maxlength="8" readonly></td>
                            <td>
<!--                              <u>REGB:</u></td><td> -->
<!--                              <div class="input"> -->
<!--                                <input id="regb" type="text" size="8" value="00000000" maxlength="8" readonly /> -->
<!--                                <span class="tooltip">Info</span> -->
<!--                              <div> -->
                            </td></tr></table>

                        <font size="2">
                        <br /><u>Instruction Set</u>
                        <br />&nbsp;&nbsp;&lt;x&gt; is a 4-bit memory address
                        <br />&nbsp;&nbsp;0000 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- NOP (Do nothing)
                        <br />&nbsp;&nbsp;0001 &lt;x&gt; -- GET value at &lt;x&gt; and put in REGA
                        <br />&nbsp;&nbsp;0010 &lt;x&gt; -- PUT value in REGA at  &lt;x&gt;
                        <br />&nbsp;&nbsp;0011 &lt;x&gt; -- ADD value at &lt;x&gt; to REGA
                        <br />&nbsp;&nbsp;0100 &lt;x&gt; -- SUB value at  &lt;x&gt; from REGA
                        <br />&nbsp;&nbsp;0101 &lt;x&gt; -- MUL REG by value at  &lt;x&gt;
                        <br />&nbsp;&nbsp;0110 &lt;x&gt; -- DIV REGA by value at  &lt;x&gt;
                        <br />&nbsp;&nbsp;1000 &lt;x&gt; -- PRINT &lt;x&gt; to Monitor
                        <br />&nbsp;&nbsp;1001 &lt;x&gt; -- INPUT keyboard to  &lt;x&gt;
                        <br />
                        </font>
		      </div>
		    </td>
		  </tr>
                 </div> <!-- end of boxes -->
		</table> <!-- end of RAM & CPU table -->
              </td>
	    </tr>
            <tr>
              <td>
               <button type="button" id="reset" onclick="reset()">Reset</button>
               <button type="button" id="fetch" onclick="fetchNextInstruction()">Fetch</button>
               <button type="button" id="exec" onclick="executeCurrentInstruction()" disabled>Execute</button>
               <button type="button" id="run" onclick="fetchExecute()">Run</button>
               <a target="_blank" href="https://docs.google.com/document/d/1_b0sq3gXLB0GZSpjKRX2qjUOvaMxsiHOLhmY1HOoclo"><button type="button" style="float:right">Help</button></a>
             </td>
            </tr>
	  </table> <!-- end of computer table -->
	</td>
      </tr>
    </table>  <!-- end of main container -->
  </body>
</html>
